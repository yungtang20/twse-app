# 任務分解 (Task Breakdown)

## 任務概覽

總預估時間: **8-12 小時**

## 階段 1: 基礎架構 (2-3 小時)

### ✅ TASK-001: 配置層與環境適配
- **優先級**: P0
- **預估時間**: 30 分鐘
- **狀態**: 已完成
- **交付物**:
  - ✅ 環境檢測函數 `get_work_directory()`
  - ✅ API URLs 配置
  - ✅ 全局常量定義
  - ✅ Android/Windows 兼容性處理

### ✅ TASK-002: 工具函數層
- **優先級**: P0
- **預估時間**: 1 小時
- **狀態**: 已完成
- **交付物**:
  - ✅ 數值轉換函數 (`safe_num`, `safe_int`)
  - ✅ 日期轉換函數 (`roc_to_western_date`)
  - ✅ 顏色格式化函數
  - ✅ 日誌系統 (`setup_logging`)
  - ✅ 用戶輸入函數 (`read_single_key`)

### ✅ TASK-003: 基礎設施層
- **優先級**: P0
- **預估時間**: 1.5 小時
- **狀態**: 已完成
- **交付物**:
  - ✅ DatabaseManager (Singleton + 上下文管理器)
  - ✅ ProgressTracker (VT100 + 線程安全)
  - ✅ StockRepository (批量寫入)

## 階段 2: 數據源層 (2-3 小時)

### 🔄 TASK-004: DataSource 基類與接口
- **優先級**: P0
- **預估時間**: 30分鐘
- **狀態**: 進行中
- **交付物**:
  - [ ] `DataSource` 抽象基類
  - [ ] `fetch_history()` 接口定義
  - [ ] 進度追蹤集成

### ⏳ TASK-005: FinMindDataSource 實現
- **優先級**: P0
- **預估時間**: 1 小時
- **依賴**: TASK-004
- **交付物**:
  - [ ] API 請求實現
  - [ ] 錯誤處理 (429, 重試)
  - [ ] 數據清洗與去重
  - [ ] 250 交易日限制

### ⏳ TASK-006: OfficialAPIDataSource 實現
- **優先級**: P0
- **預估時間**: 1.5 小時
- **依賴**: TASK-004
- **交付物**:
  - [ ] TWSE API 實現
  - [ ] TPEx API 實現
  - [ ] 民國轉西元日期處理
  - [ ] 逐月數據抓取邏輯

### ⏳ TASK-007: DataSourceManager 失敗轉移
- **優先級**: P0
- **預估時間**: 30 分鐘
- **依賴**: TASK-005, TASK-006
- **交付物**:
  - [ ] 數據源優先級管理
  - [ ] 自動失敗轉移邏輯
  - [ ] 失敗記錄

## 階段 3: 技術指標層 (2-3 小時)

### ⏳ TASK-008: WMA 核心算法
- **優先級**: P1
- **預估時間**: 45 分鐘
- **交付物**:
  - [ ] `calculate_wma()` 靜態方法
  - [ ] 權重計算邏輯
  - [ ] 序列版本 (用於批量計算)
  - [ ] 單值版本 (用於當日數據)

### ⏳ TASK-009: 基礎指標實現
- **優先級**: P1
- **預估時間**: 1 小時
- **依賴**: TASK-008
- **交付物**:
  - [ ] `calculate_rsi()` - 使用 WMA
  - [ ] `calculate_macd()` - 使用 WMA
  - [ ] `calculate_ma()` - 簡單移動平均
  - [ ] 序列版本實現

### ⏳ TASK-010: 進階指標實現
- **優先級**: P1
- **預估時間**: 1.5 小時
- **依賴**: TASK-008
- **交付物**:
  - [ ] `calculate_mfi()` - Money Flow Index
  - [ ] `calculate_vp_scheme3()` - Volume Profile
  - [ ] `calculate_vwap()` - 成交量加權平均價
  - [ ] `calculate_chg14()` - 14日漲跌幅
  - [ ] `calculate_monthly_kd()` - 月KD指標

## 階段 4: 業務邏輯層 (2-3 小時)

### ⏳ TASK-011: 股票清單管理
- **優先級**: P0
- **預估時間**: 45 分鐘
- **交付物**:
  - [ ] `step1_fetch_stock_list()` - 下載清單
  - [ ] A 規則篩選邏輯
  - [ ] CSV 存儲與讀取

### ⏳ TASK-012: 數據下載與更新
- **優先級**: P0
- **預估時間**: 1.5 小時
- **依賴**: TASK-007
- **交付物**:
  - [ ] `step2_download_tpex_daily()` - 上櫃即時
  - [ ] `step3_download_twse_daily()` - 上市即時
  - [ ] `step4_download_historical()` - 歷史數據
  - [ ] 斷點續傳邏輯
  - [ ] 進度追蹤與保存

### ⏳ TASK-013: 指標批量計算
- **優先級**: P1
- **預估時間**: 1 小時
- **依賴**: TASK-010
- **交付物**:
  - [ ] `batch_calculate_indicators()` - 批量計算
  - [ ] 快取管理 (1小時過期)
  - [ ] 內存優化 (分批處理)

### ⏳ TASK-014: 股票篩選與排行
- **優先級**: P1
- **預估時間**: 45 分鐘
- **依賴**: TASK-013
- **交付物**:
  - [ ] 多條件篩選邏輯
  - [ ] 三重篩選系統
  - [ ] 排序與分頁顯示

## 階段 5: 用戶界面層 (1-2 小時)

### ⏳ TASK-015: 主菜單系統
- **優先級**: P0
- **預估時間**: 45 分鐘
- **交付物**:
  - [ ] `main_menu()` - 主菜單
  - [ ] 單鍵選擇邏輯
  - [ ] 子菜單跳轉

### ⏳ TASK-016: 結果顯示與格式化
- **優先級**: P1
- **預估時間**: 1 小時
- **交付物**:
  - [ ] 指標顏色顯示 (漲紅跌綠)
  - [ ] 箭頭顯示 (▲▼)
  - [ ] VP 咖啡色顯示
  - [ ] 表格對齊與分頁

### ⏳ TASK-017: 個股分析工具
- **優先級**: P1
- **預估時間**: 45 分鐘
- **依賴**: TASK-010
- **交付物**:
  - [ ] `analyze_single_stock()` - 個股詳情
  - [ ] 歷史數據查詢
  - [ ] 圖表數據匯出

## 階段 6: 集成與優化 (1-2 小時)

### ⏳ TASK-018: 進度追蹤集成
- **優先級**: P0
- **預估時間**: 30 分鐘
- **交付物**:
  - [ ] `load_progress()` - 載入進度
  - [ ] `save_progress()` - 保存進度
  - [ ] `reset_progress()` - 重置進度

### ⏳ TASK-019: 雲端同步 (可選)
- **優先級**: P2
- **預估時間**: 1 小時
- **交付物**:
  - [ ] `CloudSync.upload_stock_list()` - 上傳清單
  - [ ] `CloudSync.upload_calculated_data()` - 上傳計算結果
  - [ ] Supabase API 集成

### ⏳ TASK-020: 錯誤處理與日誌
- **優先級**: P0
- **預估時間**: 30 分鐘
- **交付物**:
  - [ ] 全局異常捕獲
  - [ ] 用戶友好錯誤提示
  - [ ] 詳細日誌記錄

## 階段 7: 測試與驗證 (1-2 小時)

### ⏳ TASK-021: 功能測試
- **優先級**: P0
- **預估時間**: 1 小時
- **測試項目**:
  - [ ] 數據下載測試 (10檔股票)
  - [ ] 指標計算準確性測試
  - [ ] 篩選功能測試
  - [ ] 菜單導航測試

### ⏳ TASK-022: 性能測試
- **優先級**: P1
- **預估時間**: 30 分鐘
- **測試項目**:
  - [ ] 1000檔股票下載時間
  - [ ] 內存峰值監控
  - [ ] 並發安全測試

### ⏳ TASK-023: 兼容性測試
- **優先級**: P1
- **預估時間**: 30 分鐘
- **測試環境**:
  - [ ] Windows 10 (VT100)
  - [ ] Android/Termux (可選)
  - [ ] Python 3.7/3.8/3.9+

## 任務依賴圖

```
TASK-001 (配置)
    ↓
TASK-002 (工具) ← TASK-003 (基礎設施)
    ↓                  ↓
TASK-004 (數據源基類)
    ↓
TASK-005 (FinMind) + TASK-006 (Official)
    ↓
TASK-007 (DataSourceManager)
    ↓
TASK-011 (清單) + TASK-012 (下載)
    ↓
TASK-008 (WMA)
    ↓
TASK-009 (基礎指標) + TASK-010 (進階指標)
    ↓
TASK-013 (批量計算)
    ↓
TASK-014 (篩選) + TASK-017 (個股分析)
    ↓
TASK-015 (菜單) + TASK-016 (顯示)
    ↓
TASK-018 (進度) + TASK-019 (雲端) + TASK-020 (錯誤)
    ↓
TASK-021 (功能測試) + TASK-022 (性能測試) + TASK-023 (兼容測試)
```

## 當前進度總結

- ✅ **已完成**: TASK-001, TASK-002, TASK-003 (3/23)
- 🔄 **進行中**: TASK-004 (1/23)
- ⏳ **待開始**: TASK-005 ~ TASK-023 (19/23)
- **完成度**: 13% (3/23)

## 下一步行動

1. **立即**: 完成 TASK-004 (DataSource 基類)
2. **接著**: TASK-005, TASK-006 (數據源實現)
3. **然後**: TASK-007 (失敗轉移管理器)
