# 需求文檔 (Requirements Document)

## 0. 開發規範總則

> ⚠️ **以下規範必須嚴格遵守**

| 規範項目 | 說明 |
|---------|------|
| **介面與輸出** | 繁體中文 |
| **股票篩選 (A規則)** | 僅普通股 (TWSE+TPEX+KY)，排除 ETF/權證/DR/ETN/債券/指數/創新板/特別股/非數字代碼 |
| **進度顯示** | 三行進度 (下載/運算/輸出) |
| **任務控制** | 斷檔續讀 (檢查點保存) |
| **資料顯示** | 表格化、對齊、統一格式、即抓即顯示 |
| **資料來源** | 官方真實數據，抓到什麼就輸出什麼 |
| **流程控制** | 主頁、法人買賣超排行、每個掃描結果後，加上「輸入股票代號 (如 2330) 可直接查看個股或按 Enter 返回」 |
| **資料整併** | 各來源統一格式後寫入資料庫 |
| **數值精度** | 小數點後二位 |
| **變更管理** | 每次修改寫入計畫書 |
| **版本管理** | 另寫更新日誌 |
| **色彩規則** | 上升/漲 = 紅色；下降/跌 = 綠色 |
| **程式碼異動** | 刪除或修改前，必須先完整保存原始代碼 |
| **安裝需求** | 手機與電腦通用 |

---

## 1. 項目背景

### 1.1 現有系統分析
- **v40 (最終完全版.py)**: 2391行，現代化架構，VT100支援，但功能較簡化
- **v34 (最終完全版舊.py)**: 5769行，功能完整，但代碼冗長

### 1.2 重構目標
整合兩個版本的優點，創建模塊化、高性能、易維護的新系統。

## 2. 功能需求 (Functional Requirements)

### 2.1 核心功能
- **FR-001** 股票數據下載與更新
  - 支持 FinMind API
  - 支持官方 API (TWSE + TPEx)
  - 自動失敗轉移機制
  - 斷點續傳支持

- **FR-002** 技術指標計算
  - 基礎指標: MA, EMA, RSI, MACD, KD
  - 進階指標: WMA, MFI, VP, VWAP, CHG14
  - 月 KD 指標
  - 批量計算與快取

- **FR-003** 數據篩選與排行
  - A 規則篩選 (普通股)
  - 多條件篩選 (價格、成交量、漲跌幅)
  - 三重篩選系統
  - 自定義排序

- **FR-004** 個股分析
  - 完整技術指標顯示
  - 歷史數據查詢
  - 圖表數據匯出

### 2.2 數據管理
- **FR-005** 數據庫操作
  - SQLite 數據持久化
  - WAL 模式 (非 Android)
  - 批量寫入優化
  - 數據完整性檢查

- **FR-006** 雲端同步
  - Supabase 集成
  - 股票清單同步
  - 計算結果上傳
  - 斷線重連機制

### 2.3 用戶界面
- **FR-007** 進度顯示
  - 三行動態進度條
  - VT100 終端支持
  - 線程安全輸出
  - 自動限流 (10 FPS)

- **FR-008** 交互菜單
  - 單鍵選擇
  - 清晰的選項提示
  - 錯誤處理與提示

## 3. 非功能需求 (Non-Functional Requirements)

### 3.1 性能需求
- **NFR-001** 數據處理速度
  - 單股處理時間 < 1秒
  - 批量計算 (1000檔) < 5分鐘
  - API 請求間隔 >= 0.5秒

- **NFR-002** 內存使用
  - 峰值內存 < 500MB
  - 無內存洩漏
  - 及時釋放大型 DataFrame

### 3.2 兼容性需求
- **NFR-003** 平台支持
  - Windows 10+ (VT100)
  - Android/Termux (無 WAL)
  - Python 3.7+

- **NFR-004** 數據兼容
  - 兼容 v34/v40 數據庫
  - CSV 格式匯入匯出
  - 向後兼容

### 3.3 可維護性需求
- **NFR-005** 代碼質量
  - 行數控制在 3000-3500 行
  - 模塊化設計 (7-8 層)
  - 完整的 docstring
  - 清晰的註釋

- **NFR-006** 錯誤處理
  - 全局異常捕獲
  - 詳細的錯誤日誌
  - 用戶友好的錯誤提示

### 3.4 安全性需求
- **NFR-007** 數據安全
  - API Token 環境變量
  - SQL 注入防護 (參數化查詢)
  - SSL 證書驗證關閉 (兼容性)

## 4. 約束條件 (Constraints)

### 4.1 技術約束
- 必須使用 Python 3.7+
- 使用 SQLite 作為數據庫
- 依賴庫: pandas, numpy, requests

### 4.2 業務約束
- A 規則必須嚴格執行 (4位數字，1-9開頭)
- 只取最近 250 個交易日數據
- API 請求必須遵守速率限制

### 4.3 時間約束
- 重構完成時間: 1-2 天
- 測試驗證時間: 0.5 天

## 5. 驗收標準 (Acceptance Criteria)

### 5.1 功能驗收
- ✅ 所有 FR 功能正常運行
- ✅ 數據準確性與 v34/v40 一致
- ✅ 無重大 Bug

### 5.2 性能驗收
- ✅ 滿足所有 NFR 性能指標
- ✅ 通過壓力測試 (1000檔股票)
- ✅ 內存穩定無洩漏

### 5.3 質量驗收
- ✅ 代碼通過 Linus-style 審查
- ✅ 關鍵功能有測試覆蓋
- ✅ 文檔完整清晰

## 6. 優先級排序

### P0 (必須完成)
- 數據庫管理
- 進度追蹤系統
- 基礎指標計算
- 數據下載功能

### P1 (高優先級)
- 進階指標 (WMA, VP)
- 三重篩選系統
- 個股分析工具

### P2 (中優先級)
- 雲端同步
- 性能優化
- 錯誤處理增強

### P3 (可選)
- 額外統計功能
- UI 美化
- 更多圖表選項

## 7. 重構與測試需求 (Refactoring & Testing Requirements)

### 7.1 代碼重構
- **RT-001** 模塊化重構
  - 將 `IndicatorCalculator` 提取為獨立模塊
  - 將 `DatabaseManager` 提取為獨立模塊
  - 消除全局變量依賴

### 7.2 單元測試
- **RT-002** IndicatorCalculator 測試
  - 為 `calculate_wma` 添加測試用例
  - 為 `calculate_rsi` 添加測試用例
  - 為 `calculate_vp_scheme3` 添加測試用例
  - 確保邊界條件覆蓋 (空數據、單一數據)
