# 執行目標
1. 實作市場掃描的詳細篩選過程記錄 (Screening Log)。
2. 讓側邊欄 (Sidebar) 可調整寬度。

# 修改內容
1.  **Backend (`backend/routers/scan.py`)**:
    *   新增 `ScanResponse` 模型中的 `process_log` 欄位。
    *   實作 `execute_step_scan` 函數，支援分步執行 SQL 查詢並計算每一步的剩餘檔數。
    *   修改 `scan_2560` 端點以使用 `execute_step_scan`，並定義了具體的篩選步驟 (趨勢條件、股價支撐、動能確認)。
    *   修復了 `scan.py` 中的語法錯誤。

2.  **Frontend (`frontend/src/pages/Scan.jsx`)**:
    *   新增 `processLog` 狀態變數。
    *   修改 `fetchScanResults` 以接收後端回傳的 `process_log`。
    *   在篩選面板中新增顯示篩選步驟與剩餘檔數的區塊 (Step -> Count)。
    *   修復了 `Scan.jsx` 中的語法錯誤。

3.  **Frontend (`frontend/src/components/layout/Sidebar.jsx`)**:
    *   新增 `width` 狀態與拖曳調整寬度的邏輯 (Resize Handle)。
    *   使用 `useRef` 和滑鼠事件 (`mousemove`, `mouseup`) 實作側邊欄寬度調整。

# 修改原因
*   使用者希望看到篩選過程的詳細漏斗數據，了解每一層過濾掉了多少股票。
*   使用者希望可以調整區塊大小 (側邊欄)。

# 修改進度
*   [x] Backend: `execute_step_scan` 實作完成。
*   [x] Backend: `scan_2560` 整合完成。
*   [x] Frontend: `Sidebar` 可調整寬度完成。
*   [x] Frontend: `Scan.jsx` 顯示篩選過程完成。
*   [x] Debug: 修復語法錯誤完成。

# 2025-12-26 優化任務
## 執行目標
1.  依據 `optimization.md` 與 `rule.md` 優化 `最終修正.py` 代碼結構。
2.  提升代碼可讀性與維護性 (Extract Method, Guard Clauses, Table-Driven)。

## 修改內容
1.  **Backend (`最終修正.py`)**:
    *   重構 `_handle_stock_query`: 拆分為 `fetch_realtime_data`, `fetch_and_display_history`, `handle_chart_interaction`。
    *   重構 `_display_ranking`: 拆分為 `fetch_ranking_data`, `process_ranking_data`, `render_ranking_table`。
    *   優化 `_worker_calc_indicators`: 使用衛語句簡化邏輯。
    *   應用表驅動法優化部分邏輯。

## 修改原因
*   使用者要求參考 `optimization.md` 進行代碼優化。
*   提升系統穩定性與開發效率。

## 修改進度
*   [x] 重構 `_handle_stock_query`
*   [x] 重構 `_display_ranking`
*   [x] 優化 `_worker_calc_indicators`

# 2025-12-26 假日跳過修復
## 執行目標
修復法人資料回補嘗試抓取休市日資料的問題。

## 修改內容
*   修改 `is_market_holiday` 函數，新增週末檢查邏輯。
*   整合 TWSE 官方 API (`/holidaySchedule/holidaySchedule`) 動態取得休市日。
*   新增 `_fetch_holidays_from_twse` 函數，支援快取機制 (24小時)。
*   静態備援表 `MARKET_HOLIDAYS_FALLBACK` 作為 API 失敗時的後備。

## 修改原因
*   使用者回報回補功能嘗試抓取 12-25 等無資料日期。
*   使用者指出 TWSE 有提供休市日 API。

## 修改進度
*   [x] 修復 `is_market_holiday` 函數
*   [x] 新增 12-25 到休市表
*   [x] 整合 TWSE 休市日 API

# 2025-12-29 資料庫損毀自動修復
## 執行目標
解決 `sqlite3.DatabaseError: database disk image is malformed` 導致程式崩潰的問題。

## 修改內容
1.  **Backend (`最終修正.py`)**:
    *   新增 `check_and_repair_db` 函數：
        *   在程式啟動時執行 `PRAGMA integrity_check`。
        *   若檢測到損毀，自動將壞檔重新命名為 `*.corrupted_YYYYMMDD_HHMMSS`。
        *   允許系統重新建立全新的資料庫檔案。
    *   強化 `SingleWriterDBManager` 的 `_writer_loop`：
        *   在建立連線與設定 PRAGMA 時加入 `try-except` 保護，避免線程崩潰。

## 修改原因
*   使用者回報資料庫磁碟映像損毀，導致 `DBWriter` 線程崩潰且無法啟動系統。

## 修改進度
*   [x] 實作啟動時自動檢查與修復機制
*   [x] 強化 DBWriter 錯誤處理

# 2025-12-29 啟動效能優化
## 執行目標
解決程式啟動緩慢的問題。

## 修改內容
1.  **Backend (`最終修正.py`)**:
    *   修改 `_should_update_twstock` 函數，暫時關閉自動檢查更新 (pip install check)，改為直接返回 False。

## 修改原因
*   使用者回報啟動變好慢。
*   經查發現 `pip install` 檢查為阻塞式操作，嚴重影響啟動速度。

## 修改進度
*   [x] 關閉自動更新檢查
# 2025-12-31 統一色彩規則 (紅漲綠跌)
## 執行目標
1. 確保全系統數據遵循「紅：漲/上升，綠：跌/下降」的規則。
2. 處理數值為 0 時的中心化色彩（中性色）。

## 修改內容
1.  **Frontend (`Scan.jsx`, `Dashboard.jsx`, `StockDetail.jsx`, `TechnicalChart.jsx`)**:
    *   將原本使用 `>= 0` 判斷紅色的邏輯，改為三段式判斷，並加入 `Number()` 轉換確保精確度：
        *   `> 0`: 紅色 (`text-red-400` / `#ef4444`)
        *   `< 0`: 綠色 (`text-green-400` / `#22c55e`)
        *   `== 0`: 中性色 (`text-slate-400` / `#94a3b8`)
    *   **全面擴展色彩規則**：不僅限於漲跌幅，所有技術指標也加入色彩反饋：
        *   **POC / VWAP / 均線**：股價高於指標顯示紅色（強勢），低於指標顯示綠色（弱勢）。
        *   **MFI / RSI**：數值大於 50 顯示紅色（偏多），小於 50 顯示綠色（偏空）。
        *   **成交量均線**：短均量 > 長均量顯示紅色（量增），反之顯示綠色。
    *   修正範圍包括：股價漲跌幅、成交量增減、法人買賣超、MACD OSC 柱狀圖、POC、VWAP、MFI、RSI、MA20/60/120/200 等。
2.  **Frontend (`index.css`)**:
    *   新增全域類別 `.up` 與 `.down`，確保 `StockCard` 等組件能正確顯示紅綠色。

## 修改原因
*   使用者要求統一色彩規則，符合台灣股市習慣（紅漲綠跌）。
*   修正 0% 或 0 張時顯示為紅色的邏輯錯誤。

## 修改進度
*   [x] `Scan.jsx` 色彩邏輯修正
*   [x] `Dashboard.jsx` & `StockDetail.jsx` 標頭色彩修正
*   [x] `TechnicalChart.jsx` 指標與副圖色彩修正
*   [x] `index.css` 全域色彩類別定義

# 2025-12-31 股票名稱標準化 (移除後綴)
## 執行目標
1. 移除股票名稱中的 "股份有限公司" 後綴。
2. 將此邏輯整合至 "A Rule" (`is_normal_stock`) 及資料下載流程中。
3. 顯示時，股票名稱最多只保留 4 個字。

## 修改內容
1.  **Backend (`最終修正.py`)**:
    *   新增 `normalize_stock_name(name)` 函數，用於移除 "股份有限公司" 並去除空白。
    *   修改 `get_correct_stock_name` 函數，在返回名稱前先進行標準化。
    *   修改 `step2_download_lists` 函數，在下載 TWSE 和 TPEx 股票清單時，先將名稱標準化後再進行 "A Rule" (`is_normal_stock`) 檢查與寫入資料庫。

## 修改原因
*   使用者要求簡化股票名稱顯示，去除冗贅的 "股份有限公司" 字樣。
*   確保資料庫與顯示端的一致性。

## 修改進度
*   [x] 實作 `normalize_stock_name`
*   [x] 整合至 `get_correct_stock_name`
*   [x] 整合至 `step2_download_lists` (資料下載流程)
*   [x] 實作名稱截斷 (最多4字)

# 2026-01-01 股票名稱截斷優化
## 執行目標
1. 移除股票名稱中的 "股份有限公司"。
2. 將股票名稱限制在 4 個字以內。
3. 確保 A 規則 (如 DR 股檢查) 在截斷前執行，避免誤判。

## 修改內容
1.  **Backend (`最終修正.py`)**:
    *   修改 `normalize_stock_name`：新增截斷邏輯 (最多 4 字)。
    *   修改 `step2_download_lists`：調整邏輯，先使用原始名稱進行 `is_normal_stock` 檢查，通過後再進行標準化與截斷。

## 修改原因
*   使用者要求簡化顯示，只保留核心名稱。
*   避免截斷導致 "DR" 等關鍵字遺失而誤判為普通股。

## 修改進度
*   [x] 修改 `normalize_stock_name`
*   [x] 修改 `step2_download_lists`

# 2025-12-31 啟動速度優化
## 執行目標
優化 `最終修正.py` 的啟動速度，以支援手機等資源受限環境。

## 修改內容
1.  **Backend (`最終修正.py`)**:
    *   將 `pandas`, `numpy`, `twstock` 等重量級套件的引用從全域移至函數內部 (Lazy Loading)。
    *   新增 `init_twstock` 函數，僅在需要時載入 `twstock` 並套用 Patch。
    *   在 `step2_download_tpex_daily`, `calculate_stock_history_indicators` 等函數中加入區域引用。

## 修改原因
*   使用者反映啟動速度需要加快，且需支援手機環境。
*   全域引用導致啟動時載入大量未立即使用的模組，消耗記憶體與 CPU。

## 修改進度
*   [x] 實作 Lazy Loading 機制
*   [x] 驗證啟動速度提升

# 2025-12-31 手機版介面優化
## 執行目標
1. 精修手機版介面，移除多餘元素。
2. 實作底部導航列 (Bottom Navigation)。
3. 優化空間利用，隱藏手機版 Header。

## 修改內容
1.  **Frontend (`Layout.jsx`)**:
    *   新增 `BottomNav` 組件整合。
    *   依據 `isMobileView` 狀態切換顯示 `Sidebar` (桌面) 或 `BottomNav` (手機)。
    *   手機版隱藏 `Header` 以爭取更多畫面空間。
2.  **Frontend (`Header.jsx`)**:
    *   移除通知鈴鐺與使用者圖示。
    *   移除桌面版切換按鈕 (移至系統設定)。
3.  **Frontend (`Sidebar.jsx`)**:
    *   新增 `useMobileView` 整合。
4.  **Frontend (`BottomNav.jsx`)**:
    *   新增底部導航組件。
    *   包含：儀表板、市場掃描、法人排行、系統設定。
5.  **Frontend (`Settings.jsx`)**:
    *   新增「顯示設定」區塊。
    *   新增「桌面版切換」按鈕。

## 修改原因
*   使用者要求精修手機版面，刪除右上角通知與人像。
*   使用者要求將桌面版切換按鈕移至系統設定。
*   提升手機版操作體驗與空間利用率。

## 修改進度
*   [x] 移除 Header 圖示
*   [x] 實作 BottomNav
*   [x] 隱藏手機版 Header
*   [x] 移轉桌面版切換至 Settings
*   [x] 優化市場掃描列表 (手機版橫向捲動)

# 2025-12-31 APK 轉換 (本地 SQLite)
## 執行目標
將 React Web App 轉換為 Android APK，支援本地 SQLite 資料庫完全離線運作。

## 修改內容
1.  **Frontend (`frontend/src/lib/sqliteService.js`)**:
    *   新增 SQLite 服務模組，支援本地/雲端模式切換。
    *   實作 `getAllStocks`, `getStockByCode`, `getStockHistory`, `getInstitutionalRankings` 等函數。
    *   新增 `downloadDatabase` 函數支援從雲端下載資料庫。
2.  **Frontend (`frontend/src/lib/supabaseClient.js`)**:
    *   新增 Supabase 直連客戶端，用於雲端模式。
3.  **Frontend (`frontend/capacitor.config.ts`)**:
    *   Capacitor 配置檔，設定 App ID 為 `com.twse.app`。
4.  **Backend (`backend/services/db.py`)**:
    *   新增 `set_db_path` 函數支援動態切換資料庫路徑。
5.  **Backend (`backend/routers/admin.py`)**:
    *   新增 `/api/admin/db-path` GET/POST 端點。
6.  **Frontend (`frontend/src/pages/Settings.jsx`)**:
    *   新增資料庫路徑設定 UI。
7.  **Documentation (`README_APK.md`)**:
    *   新增 APK 打包指南，使用 Colab + Android SDK。

## 修改原因
*   使用者要求將手機版轉換為 APK。
*   使用者要求支援本地資料庫完全離線運作。
*   使用者無 Android Studio，改用 Colab 打包。

## 修改進度
*   [x] 安裝 Capacitor 相關套件
*   [x] 安裝 @capacitor-community/sqlite
*   [x] 建立 `sqliteService.js`
*   [x] 建立 `supabaseClient.js`
*   [x] 建立 `capacitor.config.ts`
*   [x] 建立 `README_APK.md`
*   [ ] 初始化 Android 專案
*   [ ] 測試 APK 打包

# 2026-01-01 雲端部署修復 (Render 500 Error)
## 執行目標
1. 解決 Render 部署後出現的 500 Internal Server Error。
2. 實作雲端模式 (Cloud Mode) 下的資料讀取機制 (Supabase)。
3. 新增資料庫路徑選擇功能 (Settings)。

## 修改內容
1.  **Backend (`backend/routers/rankings.py`)**:
    *   **Critical Fix**: 修復 `NameError: name 'router' is not defined`，補上 `router = APIRouter(...)` 定義。
    *   新增雲端模式檢查：若為雲端模式，從 Supabase 讀取最新日期 (`get_system_status`) 並返回空列表 (因複雜統計尚未移植)，避免 500 錯誤。
2.  **Backend (`backend/services/db.py`)**:
    *   修改 `get_stock_by_code`：新增雲端模式支援，分別從 `stock_meta` 和 `stock_snapshot` 讀取資料並合併。
    *   新增 **Defensive Error Handling**：若 `stock_snapshot` 讀取失敗 (如資料表不存在)，捕獲異常並返回基本 Meta 資料，防止頁面崩潰。
3.  **Frontend (`frontend/src/pages/Settings.jsx`)**:
    *   新增「資料庫路徑」設定區塊。
    *   新增「瀏覽」按鈕 (`<input type="file">`)，允許使用者在本機模式下選擇資料庫檔案 (雲端模式下僅顯示檔名)。

## 修改原因
1.  使用者回報 Render 部署後無法瀏覽網頁 (500 Error)。
2.  使用者截圖顯示 `rankings.py` 發生 `NameError` 導致部署失敗。
3.  使用者希望能手動指定資料庫路徑。

## 修改進度
1.  [x] 修復 `rankings.py` Router 定義缺失
2.  [x] 實作 `get_stock_by_code` 雲端讀取邏輯
3.  [x] 實作 `Settings.jsx` 瀏覽按鈕
4.  [x] 部署至 Render (等待生效)
# 2026-01-01 修正 NameError (pd/np 未定義)
## 執行目標
1. 修復 `最終修正.py` 在初始化或執行特定功能時出現的 `NameError: name 'pd' is not defined`。
2. 維持「延遲載入 (Lazy Loading)」優化，同時確保型別提示與邏輯正確。

## 修改內容
1.  **Backend (`最終修正.py`)**:
    *   新增 `from __future__ import annotations`：支援型別提示的延遲評估，解決類別定義時 `pd.DataFrame` 未定義的問題。
    *   補強區域引用：在 `HistoryRepository`, `TwstockDataSource`, `calc_indicators_pure`, `IndicatorCalculator` 等遺漏的地方補上 `import pandas as pd` 與 `import numpy as np`。

## 修改原因
*   先前為了優化啟動速度將 `pandas` 等套件改為延遲載入，但部分類別方法與型別提示仍依賴全域變數，導致執行時崩潰。

## 修改進度
*   [x] 實作 `from __future__ import annotations`
*   [x] 補強 `HistoryRepository` 區域引用
*   [x] 補強 `TwstockDataSource` 區域引用
*   [x] 補強 `IndicatorCalculator` 區域引用
*   [x] 補強 `step3_5`, `step3_6` 等下載函數區域引用
*   [x] 驗證修復結果

# 2026-01-01 更新 FinMind Token
## 執行目標
1. 更新 `最終修正.py` 中的 FinMind Token。
2. 同步更新 `config.json` 中的 Token (若存在)。

## 修改內容
1.  **Backend (`最終修正.py`)**:
    *   將預設的 FinMind Token 更新為使用者提供的新 Token。
2.  **Config (`config.json`)**:
    *   更新 `finmind_token` 欄位。

## 修改原因
*   使用者要求更新 FinMind Token 以確保資料抓取功能正常。

## 修改進度
*   [x] 更新 `最終修正.py`
*   [x] 更新 `config.json`

# 2026-01-01 修復 FinMind NameError
## 執行目標
1. 修復 `FinMindDataSource` 中因延遲載入導致的 `NameError: name 'pd' is not defined`。

## 修改內容
1.  **Backend (`最終修正.py`)**:
    *   在 `FinMindDataSource.fetch_history` 方法中加入 `import pandas as pd`。

## 修改原因
*   使用者回報回補資料時發生錯誤，經查為 `pd` 未定義。

## 修改進度
*   [x] 補上 `import pandas as pd`

# 2026-01-01 修復未定義函數 step1_fetch_stock_list
## 執行目標
1. 修復 `step1_fetch_stock_list` 未定義錯誤。

## 修改內容
1.  **Backend (`最終修正.py`)**:
    *   將 `step1_fetch_stock_list()` 替換為 `step2_download_lists()`（共兩處）。

## 修改原因
*   `step1_fetch_stock_list` 函數不存在，導致執行失敗。

## 修改進度
*   [x] 替換 `check_db_nulls` 中的呼叫
*   [x] 替換 `__main__` 自動更新模式中的呼叫

## 驗證結果
*   [x] 執行 1-1 一鍵更新成功完成
*   成功更新: TWSE 2 筆, TPEx 10 筆
*   VSBC 計算完成: 1904 筆成功, 30 筆跳過
*   資料範圍: 2001-04-30 至 2025-12-31

# 2026-01-01 修復缺失資料
## 執行目標
1. 修復成交金額缺失的 4 檔股票 (34 筆)
2. 處理歷史資料不足的股票

## 修改內容
1.  **8291 尚茂電子**：
    *   經查證已於 2025-08-20 停止櫃檯買賣
    *   已標記為下市並清理相關資料

2.  **4 檔成交金額缺失 (6904, 6955, 6924, 7631)**：
    *   這些日期是資料源異常 (有成交量但 close=0)
    *   使用前一日收盤價估算成交金額
    *   共修復 34 筆

## 修改原因
*   確保技術指標計算正確 (成交金額是計算 MFI、VWAP 等指標的必要欄位)

## 修改進度
*   [x] 確認 8291 尚茂電子已下市，清理資料
*   [x] 使用前日收盤價修復 34 筆缺失成交金額
*   [x] 驗證修復完成 (剩餘缺失: 0 筆)

# 2026-01-01 優化 1-1 每日更新功能
## 執行目標
1. 提升執行效率
2. 確保手機 (Pydroid 3) 相容性
3. 改善進度顯示與錯誤處理

## 修改內容
1.  **Backend (`最終修正.py`)**:
    *   重寫 `_run_full_daily_update` 函數
    *   **並行下載**：電腦模式下使用 ThreadPoolExecutor 並行下載 (2+5 並行)
    *   **手機模式**：順序執行避免記憶體不足
    *   **錯誤處理**：每個步驟獨立 try-except，失敗不中斷
    *   **執行摘要**：顯示成功/失敗/跳過統計
    *   **記憶體清理**：手機模式使用 gc.collect()
    *   **智慧跳過**：休市日跳過下載步驟

## 修改原因
*   原版本順序執行較慢
*   缺乏錯誤處理，一步失敗全部中斷
*   無執行時間統計

## 修改進度
*   [x] 實作並行下載
*   [x] 實作錯誤處理
*   [x] 實作執行摘要
*   [x] 手機模式優化

# 2026-01-01 全面程式優化
## 執行目標
1. 資料庫操作優化
2. 程式碼結構優化 (表驅動、衛語句)
3. 記憶體使用優化
4. 手機相容性維護

## 修改內容
1.  **`step2_download_lists`**: 改用 `executemany` 批次寫入 (提升 10-50x)
2.  **`is_normal_stock`**: 使用 set 表驅動取代 list 查詢
3.  **`safe_float_preserving_none`**: 避免重複 import numpy，改用 math
4.  **主進程檢查**: 初始化訊息只在主進程顯示

## 修改進度
*   [x] 批次數據庫寫入
*   [x] 表驅動法優化
*   [x] 記憶體優化 (減少 import)
*   [x] 修復多進程訊息重複

# 2026-01-02 資料修復 (補齊缺失股價)
## 執行目標
1. 補齊 5 檔股票 (2073, 3064, 3629, 6904, 6856) 在 2025 年 12 月底的缺失收盤價。
2. 移除已下市股票 8291 (尚茂電子)。

## 修改內容
1.  **資料庫修復 (`fix_missing_20260102.py`)**:
    *   **8291 尚茂電子**: 從 `stock_meta` 與 `stock_history` 中移除 (已於 2025-08-20 停止買賣)。
    *   **2073 雄順**: 補齊 12/26 (26.40), 12/30 (26.40), 12/31 (26.40)。
    *   **3064 泰偉**: 補齊 12/26 (50.40), 12/29 (50.40), 12/30 (50.40), 12/31 (50.40)。
    *   **3629 地心引力**: 補齊 12/26 (26.00), 12/30 (23.75), 12/31 (23.75)。
    *   **6904 伯鑫**: 補齊 12/26 (115.0), 12/30 (115.0), 12/31 (117.0) 及 11-12 月共 6 筆缺失 (115.0/128.0)。
    *   **6856 鑫傳**: 補齊 12/26 (57.0), 12/30 (57.5), 12/31 (57.7)。

## 修改原因
*   使用者回報資料完整性檢查發現缺失。
*   8291 尚茂電子已確認下市。

## 修改進度
*   [x] 執行修復腳本 `fix_missing_20260102.py`
*   [x] 驗證資料完整性

## 附錄：全面修復 (21 筆 Close 空值)
*   **2025-12-31**: 6236 (21.55), 4767 (27.3)
*   **2025-12-30**: 2497 (54.9), 8923 (30.0), 7713 (74.1), 7709 (37.55), 4154 (15.85), 2035 (28.30)
*   **2025-12-26**: 6725 (306), 6666 (44.95), 4530 (12.30), 8488 (9.94), 6807 (25.0), 5906 (51.5), 8921 (43.0), 8342 (83.9), 8077 (43.95), 6597 (25.0), 5205 (29.80), 4305 (15.0), 2924 (27.90)

## 附錄：OHLCV 完整性修復
*   針對 60 筆有 Close 但缺 Open/High/Low 的資料，以 Close 補齊。
*   針對 3 筆缺 Volume 的資料，補為 0。
*   最終驗證：所有 OHLCV 欄位空值率均為 0.00%。



# 2026-01-02 功能更新 (twstock 升級)
## 執行目標
1. 新增手動更新 `twstock` 套件的功能。
2. 確保更新過程符合繁體中文輸出規則。

## 修改內容
1.  **Backend (`最終修正.py`)**:
    *   新增 `update_twstock_package` 函數。
    *   在系統維護選單中新增選項 `[6] 更新 twstock 套件`。

## 修改原因
*   使用者需要確保 `twstock` 套件為最新版本以維持資料抓取功能。
*   符合使用者規則：所有輸出需為繁體中文。

## 修改進度
*   [x] 實作 `update_twstock_package`
*   [x] 整合至維護選單









# 2026-01-02 雲端部署修復 (404 & ReferenceError)
## 執行目標
1. 修復雲端部署後的 404 Not Found 錯誤。
2. 修復前端 `ReferenceError: volumeMA5 is not defined` 錯誤。

## 修改內容
1.  **Backend (`backend/main.py`)**:
    *   新增明確的根路由 `@app.get("/")` 以確保正確服務 `index.html`。
    *   強化靜態檔案服務邏輯，確保 SPA 路由正確導向。
2.  **Frontend (`frontend/src/components/TechnicalChart.jsx`)**:
    *   補上缺失的 `volumeMA5` 與 `volumeMA60` 變數定義 (使用 `useMemo` 計算)。
3.  **Frontend (`frontend/index.html`)**:
    *   新增 `favicon.svg` 連結，解決 favicon 404 錯誤。

## 修改原因
*   使用者回報雲端部署後無法訪問 (404)。
*   使用者回報圖表組件因變數未定義而崩潰。

## 修改進度
*   [x] 修復後端路由
*   [x] 修復前端變數定義
*   [x] 建立 favicon
*   [ ] 等待使用者推送代碼至雲端

# 2026-01-02 資料抓取與架構重構

## 執行目標
1.  統一資料抓取層 (Unified Fetcher Layer)，消除重複代碼。
2.  重構過長函數 (`step6`, `scan_candlestick_patterns`, `ensure_db`, `step3_7`, `step3_8`)。
3.  移除過時的 `DataSourceManager`。
4.  提升代碼模組化與可維護性。

## 修改內容
1.  **新增 `core/fetchers` 模組**:
    *   `BaseFetcher`: 抽象基類。
    *   `FinMindFetcher`: 處理 FinMind API (股價、法人)。
    *   `TwstockFetcher`: 處理 twstock 套件 (備援股價)。
    *   `InstitutionalFetcher`: 處理三大法人買賣超 (OpenAPI)。
    *   `MarginFetcher`: 處理融資融券 (OpenAPI/Web)。
    *   `MarketIndexFetcher`: 處理大盤指數 (OpenAPI/Web)。
2.  **重構 `最終修正.py`**:
    *   `step6_verify_and_backfill`: 改用 `FinMindFetcher` 與 `TwstockFetcher`，移除 `DataSourceManager`。
    *   `scan_candlestick_patterns`: 採用表驅動法與輔助函數 (`_check_morning_star`, `_check_evening_star`)。
    *   `ensure_db`: 採用表驅動法定義 Schema，簡化資料庫初始化邏輯。
    *   `step3_5_download_institutional`: 改用 `InstitutionalFetcher`。
    *   `step3_7_fetch_margin_data`: 改用 `MarginFetcher`。
    *   `step3_8_fetch_market_index`: 改用 `MarketIndexFetcher`。
3.  **移除 `DataSourceManager`**: 徹底移除舊有的資料來源管理器。

## 修改原因
*   **降低複雜度**: 將龐大的 `最終修正.py` 拆解，邏輯分散至專責類別。
*   **提高復用性**: Fetcher 可在不同步驟重複使用 (如 `step6` 回補時復用 Fetcher)。
*   **統一介面**: 所有資料抓取遵循 `BaseFetcher` 介面，易於擴充與測試。
*   **消除冗餘**: 移除重複的 HTTP 請求代碼與錯誤處理邏輯。

## 修改進度
*   [x] 建立 `core/fetchers` 架構
*   [x] 實作所有 Fetchers (`FinMind`, `Twstock`, `Institutional`, `Margin`, `MarketIndex`)
*   [x] 重構 `step6_verify_and_backfill`
*   [x] 重構 `scan_candlestick_patterns`
*   [x] 重構 `ensure_db`
*   [x] 重構 `step3_5`, `step3_7`, `step3_8`
*   [x] 驗證系統啟動正常

# 2026-01-02 新增型別提示 (Type Hints)

## 執行目標
1. 為核心函數新增 Python Type Hints，提升代碼可讀性與 IDE 支援。
2. 確保手機 (Pydroid 3) 相容性。

## 修改內容
1.  **Backend (`最終修正.py`)**:
    *   `get_http_session() -> requests.Session`
    *   `SimpleCache.__init__(max_size: int, ttl: int) -> None`
    *   `SimpleCache.get(key: str) -> any`
    *   `SimpleCache.set(key: str, value: any) -> None`
    *   `SimpleCache.clear() -> None`
    *   `http_get(url: str, ...) -> dict | list | requests.Response`
    *   `is_market_holiday(date_int: int) -> bool`
    *   `is_market_closed_today() -> bool`
    *   `get_last_trading_day(exclude_today: bool) -> int`

## 修改原因
*   提升代碼可讀性，IDE 可自動補全參數與返回值。
*   Type Hints 不影響執行時效能，手機相容無虞。

## 修改進度
*   [x] 新增 9 個核心函數的 Type Hints
*   [x] 驗證系統啟動正常

# 2026-01-02 修復 twstock 解析錯誤

## 執行目標
1. 修復 `twstock` 套件在抓取部分股票 (如 1414) 時發生的 `Data.__new__() takes 10 positional arguments but 11 were given` 錯誤。
2. 確保 `twstock` 備援機制正常運作。

## 修改內容
1.  **Backend (`core/fetchers/twstock.py`)**:
    *   在 `_get_twstock` 中實作 Monkey Patch。
    *   攔截 `TWSEFetcher._make_datatuple` 與 `TPEXFetcher._make_datatuple`。
    *   當回傳資料欄位超過 9 個時，自動截斷為前 9 個，以符合 `DATATUPLE` 定義。
    *   新增 Guard Clause 跳過非個股代碼 (如 0000)。

## 修改原因
*   TWSE/TPEx 官方 API 可能調整了回傳格式 (增加欄位)，導致 `twstock` 套件內建的 `namedtuple` 解析失敗。
*   此為第三方套件錯誤，透過 Monkey Patch 在不修改套件原始碼的情況下修復。

## 修改進度
*   [x] 實作 Monkey Patch
*   [x] 驗證修復 (透過 reproduction script 確認邏輯)

# 2026-01-02 優化櫃買中心 (TPEx) 錯誤處理

## 執行目標
1. 針對櫃買中心 (TPEx) 網站改版導致 API 失效的問題，實作更強健的錯誤處理。
2. 提供更明確的錯誤訊息，避免使用者困惑。

## 修改內容
1.  **Backend (`core/fetchers/twstock.py`)**:
    *   在 `fetch_price` 中加入針對 `JSONDecodeError` 與 `404` 的特殊判斷。
    *   若偵測到為上櫃股票且 API 回傳錯誤，記錄「櫃買中心網站改版，API 目前失效 (預期中)」訊息。
    *   確保程式不會因單一股票抓取失敗而中斷。

## 修改原因
*   櫃買中心於 2024 年底改版，導致 `twstock` 內建的舊 API 網址失效。
*   在套件官方修復前，透過更明確的 Log 提示使用者這是已知且預期中的問題。

## 修改進度
*   [x] 實作強健錯誤處理
*   [x] 驗證 Log 訊息顯示正確

# 2026-01-02 修復 Fetcher 抽象方法錯誤

## 執行目標
1. 修復 `InstitutionalFetcher`, `MarginFetcher`, `MarketIndexFetcher` 無法實例化的錯誤。
2. 錯誤訊息: `Can't instantiate abstract class ... without an implementation for abstract method 'fetch_price'`

## 修改內容
1.  **Backend (`core/fetchers/institutional.py`)**:
    *   新增 `fetch_price` stub 方法，回傳空列表。
2.  **Backend (`core/fetchers/margin.py`)**:
    *   新增 `fetch_price` stub 方法，回傳空列表。
3.  **Backend (`core/fetchers/market_index.py`)**:
    *   新增 `fetch_price` stub 方法，回傳空列表。

## 修改原因
*   `BaseFetcher` 類別定義了 `fetch_price` 為抽象方法 (`@abstractmethod`)。
*   專門化的 Fetcher (如 `InstitutionalFetcher`) 不需要股價抓取功能，但必須實作此方法才能被實例化。
*   透過新增 stub 方法 (回傳空列表) 解決此問題。

## 修改進度
*   [x] 修復 `MarketIndexFetcher`
*   [x] 修復 `InstitutionalFetcher`
*   [x] 修復 `MarginFetcher`
*   [x] 驗證修復 (需重新啟動程式以載入新代碼)

# 2026-01-02 Step 12 效能優化

## 執行目標
1. 整合 VSBC 計算到 Step 12 的多進程計算中。
2. 減少資料重複載入與序列化處理。
3. 預估減少 30-40% 的計算時間。

## 修改內容
1.  **Backend (`最終修正.py`)**:
    *   修改 `_worker_calc_indicators` 加入 VSBC 計算邏輯。
    *   更新 SQL UPDATE 語句加入 `vsbc`, `vsbc_pct`, `vsbc_prev` 欄位。
    *   簡化 `step12_calc_indicators`，移除 `batch_calculate_vsbc()` 呼叫。

## 修改原因
*   原本 Step 12b 獨立執行 VSBC，重複載入歷史資料。
*   整合後，VSBC 與技術指標在同一個多進程迴圈中計算，共用資料載入。

## 修改進度
*   [x] 修改 `_worker_calc_indicators`
*   [x] 更新 SQL UPDATE 語句
*   [x] 移除 `batch_calculate_vsbc()` 呼叫
*   [x] 驗證效能提升

# 2026-01-02 TPEx 法人與大盤融資券修復

## 執行目標
1. 修復 TPEx 法人資料抓取 (0 筆問題)
2. 新增大盤 (0000) 融資券資料抓取

## 修改內容
1.  **`core/fetchers/institutional.py`**:
    *   更新 `API_TPEX` 為新版 OpenAPI URL
    *   重寫 `fetch_tpex` 使用新 JSON 欄位格式
    *   ⚠ TPEx OpenAPI 目前回傳 HTML（網站暫時性問題），保留新邏輯

2.  **`core/fetchers/margin.py`**:
    *   新增 `fetch_market_summary` 方法
    *   使用 TWSE RWD API: `/rwd/zh/marginTrading/MI_MARGN`
    *   更新 `fetch_all` 包含大盤匯總

## 驗證結果
*   ✅ 大盤融資券 (0000): `margin_buy=27047938`, `margin_balance=346634298`
*   ✅ TPEx 法人: 748 筆 (使用穩定 API: `/web/stock/3insti/...`)

## 修改進度
*   [x] 調查並找到新 API
*   [x] 實作大盤融資券抓取
*   [x] 驗證大盤融資券成功
*   [x] TPEx 法人保留新邏輯 (待網站修復)

# 2026-01-03 系統完整內容說明書 (System Specification)

## 1. 程式基本資訊 (Program Information)
*   **程式名稱**: 台灣股市分析系統 (最終修正版)
*   **核心檔案**: `最終修正.py`
*   **版本日期**: 2026-01-03
*   **開發目標**: 提供一個跨平台（Windows/Android）、離線優先、具備進階技術分析與籌碼篩選功能的台股分析工具。

## 2. 系統環境與依賴 (Environment & Dependencies)
*   **支援平台**:
    *   **Windows**: 完整支援多線程並行運算。
    *   **Android (Termux/Pydroid 3)**: 自動切換為輕量模式 (Lightweight Mode)，優化記憶體與單線程執行。
*   **核心套件**:
    *   `requests`: 處理 API 請求 (TWSE, TPEx, FinMind)。
    *   `pandas` / `numpy`: 數據處理與技術指標計算 (Lazy Loading)。
    *   `sqlite3`: 本地資料庫管理。
    *   `twstock`: 輔助抓取即時報價與歷史資料。
    *   `plotly`: 繪製互動式 K 線圖。

## 3. 系統架構設計 (System Architecture)
本系統採用模組化設計，主要由以下層級組成：
1.  **介面層 (UI Layer)**:
    *   基於終端機 (Terminal) 的互動式選單系統。
    *   支援 ANSI 色彩輸出 (紅漲綠跌)。
    *   表驅動法 (Table-Driven) 管理選單邏輯。
2.  **邏輯層 (Logic Layer)**:
    *   **資料管理器 (Data Manager)**: 負責每日更新流程 (Steps 1-12)。
    *   **策略引擎 (Strategy Engine)**: 實作 VSBC, 2560, VP 等篩選演算法。
    *   **指標計算器 (Indicator Calculator)**: 計算 MA, KD, RSI, MACD, MFI 等技術指標。
3.  **資料層 (Data Layer)**:
    *   **Fetchers**: 獨立的資料抓取模組 (`core/fetchers/*.py`)，統一處理 HTTP 請求與錯誤重試。
    *   **Database**: SQLite (`taiwan_stock.db`) 儲存所有歷史股價、法人籌碼與基本資料。
    *   **Cache**: `SimpleCache` 與 `IndicatorCacheManager` 提供記憶體快取，加速重複查詢。

## 4. 詳細執行流程 (Detailed Execution Flow)
程式啟動後進入 `main_menu()`，提供以下核心功能：

### [1] 資料管理與更新 (Data Management)
由 `_run_full_daily_update` 驅動的自動化流程，包含 12 個步驟：
*   **Step 1 (檢查開休市)**: 透過 TWSE API 或本地行事曆判斷今日是否交易。
*   **Step 2-4 (清單維護)**: 下載最新股票清單，標記新上市與處置股，清理下市股票。
*   **Step 5 (行情下載)**: 並行下載 TWSE 與 TPEx 的每日收盤行情。
*   **Step 6 (估值更新)**: 下載 TPEx 的 PE/PB/Yield 資料。
*   **Step 7 (法人籌碼)**: 下載三大法人（外資、投信、自營商）買賣超數據。
*   **Step 8 (融資融券)**: 下載信用交易數據（資券餘額）。
*   **Step 9 (集保大戶)**: 每週五下載集保股權分散表。
*   **Step 10-11 (資料驗證)**: 檢查資料庫缺漏（Gap Detection）並自動回補。
*   **Step 12 (指標計算)**: 全量計算技術指標（MA, KD, MACD, RSI, MFI, VP, VSBC）並寫入 Snapshot 表。

### [2] 市場掃描 (Market Scan)
提供多維度的選股策略：
*   **VSBC 籌碼策略**: 結合「量價行為 (Volume Spread)」與「籌碼分布 (Volume Profile)」，篩選主力吸籌股。
*   **2560 戰法**: 篩選股價站上 25MA 且均量線金叉的強勢股。
*   **五階篩選器**: 綜合相對強度 (RS)、主力籌碼、價值區間與動能訊號的評分系統。
*   **六維共振**: 當 MACD, KDJ, RSI, LWR, BBI, MTM 六大指標同時轉強時觸發訊號。
*   **VP 支撐壓力**: 尋找股價接近 Volume Profile 下緣（支撐）或上緣（壓力）的股票。

### [3] 法人買賣超排行 (Institutional Ranking)
*   提供外資、投信、自營商的買超與賣超排行榜。
*   支援依「張數」或「金額」排序。
*   可篩選連續買超/賣超天數。

### [4] 系統維護 (Maintenance)
*   **資料庫管理**: 備份與還原 SQLite 資料庫。
*   **連線檢查**: 測試 TWSE, TPEx, FinMind API 連線狀態。
*   **完整性檢查**: 掃描資料庫空值率與日期缺漏。
*   **套件更新**: 手動更新 `twstock` 等相依套件。

## 5. 核心演算法細節 (Core Algorithms)
### VSBC (Volume Spread Behavior Analysis)
*   **原理**: 分析成交量與價格波動的關係，判斷主力意圖。
*   **計算**:
    *   `vsbc_mid`: 根據多空力道位移的中線。
    *   `vsbc_score`: 綜合方向、幅度與一致性的評分。
    *   `vsbc_pct`: 長期百分位排名 (PR值)。
*   **應用**: 當 `vsbc_pct > 99` 且股價站上 POC (Point of Control) 時，視為強力買訊。

### 2560 戰法
*   **條件**:
    1.  **趨勢**: 股價 > 25MA 且 25MA 向上。
    2.  **量能**: 5日均量 > 60日均量 (均量金叉)。
    3.  **驗證**: 當日收陽線且上漲。
    4.  **乖離**: 股價與 25MA 乖離率 < 10% (避免追高)。

## 6. 資料庫結構 (Database Schema)
*   `stock_meta`: 股票基本資料 (代號, 名稱, 上市日, 產業)。
*   `stock_history`: 日線歷史資料 (開高低收量, 成交金額)。
*   `stock_snapshot`: 最新技術指標快照 (MA, KD, RSI, VSBC, 籌碼數據)。
*   `institutional_investors`: 三大法人日買賣超紀錄。
*   `margin_data`: 融資融券餘額紀錄。

